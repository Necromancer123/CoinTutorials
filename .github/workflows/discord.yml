name: Notify Discord on Push

on: push

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changes
        run: |
          echo "added=$(git diff --name-only --diff-filter=A HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "modified=$(git diff --name-only --diff-filter=M HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "deleted=$(git diff --name-only --diff-filter=D HEAD~1 HEAD)" >> $GITHUB_OUTPUT

      - name: Build Discord embed JSON
        id: msg
        run: |
          REPO_OWNER=Necromancer123
          REPO_NAME=CoinTutorials
          BRANCH=main
          GDB_URL=https://gdbrowser.com/
          skip_file=".github/workflows/discord.yml"

          EMBEDS="[]"

          basename_noext() {
            echo "$(basename "$1" .json)"
          }

          add_embed() {
            local type="$1"
            local emoji="$2"
            local file="$3"
            FILE_NAME=$(basename_noext "$file")
            GITHUB_URL="https://github.com/$REPO_OWNER/$REPO_NAME/blob/$BRANCH/$file"
            DESCRIPTION="${emoji} [GD Browser Link](${GDB_URL}${FILE_NAME}) | [${FILE_NAME}](${GITHUB_URL})"

            EMBED_JSON=$(jq -n \
              --arg title "$type $FILE_NAME" \
              --arg description "$DESCRIPTION" \
              '{title: $title, description: $description, color: 7506394}')
            
            EMBEDS=$(echo "$EMBEDS" | jq ". + [$EMBED_JSON]")
          }

          # Added files
          if [ -n "${{ steps.changes.outputs.added }}" ]; then
            for f in ${{ steps.changes.outputs.added }}; do
              [ "$f" = "$skip_file" ] && continue
              add_embed "Added tutorial for: " "$f"
            done
          fi

          # Edited files
          if [ -n "${{ steps.changes.outputs.modified }}" ]; then
            for f in ${{ steps.changes.outputs.modified }}; do
              [ "$f" = "$skip_file" ] && continue
              add_embed "Edited tutorial for: " "$f"
            done
          fi

          # Deleted files
          if [ -n "${{ steps.changes.outputs.deleted }}" ]; then
            for f in ${{ steps.changes.outputs.deleted }}; do
              [ "$f" = "$skip_file" ] && continue
              add_embed "Deleted tutorial for: " "$f"
            done
          fi

          if [ "$EMBEDS" = "[]" ]; then
            MESSAGE="{\"content\": \"No tutorial changes detected.\"}"
          else
            MESSAGE=$(jq -n --argjson embeds "$EMBEDS" '{embeds: $embeds}')
          fi

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Send Discord embed
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "${{ steps.msg.outputs.message }}" \
            ${{ secrets.DISCORD_WEBHOOK }}
