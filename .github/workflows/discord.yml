name: Notify Discord on Push

on: push

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changes
        run: |
          echo "added=$(git diff --name-only --diff-filter=A HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "modified=$(git diff --name-only --diff-filter=M HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "deleted=$(git diff --name-only --diff-filter=D HEAD~1 HEAD)" >> $GITHUB_OUTPUT

      - name: Build Discord message
        id: msg
        run: |
          REPO_OWNER=Necromancer123
          REPO_NAME=CoinTutorials
          BRANCH=main
          GDB_URL=https://gdbrowser.com/

          MESSAGE=""

          # Function to get base filename without extension
          basename_noext() {
            echo "$(basename "$1" .json)"
          }

          # Skip workflow file itself
          skip_file=".github/workflows/discord.yml"

          # Helper to add message line
          add_message() {
            local type="$1"
            local file="$2"
            FILE_NAME=$(basename_noext "$file")
            GITHUB_URL="https://github.com/$REPO_OWNER/$REPO_NAME/blob/$BRANCH/$file"
            MESSAGE="${MESSAGE}${type} [${FILE_NAME}](${GDB_URL}${FILE_NAME}) [${FILE_NAME}](${GITHUB_URL}) "
          }

          # Added files
          if [ -n "${{ steps.changes.outputs.added }}" ]; then
            for f in ${{ steps.changes.outputs.added }}; do
              [ "$f" = "$skip_file" ] && continue
              add_message "Added tutorial for:" "$f"
            done
          fi

          # Edited files
          if [ -n "${{ steps.changes.outputs.modified }}" ]; then
            for f in ${{ steps.changes.outputs.modified }}; do
              [ "$f" = "$skip_file" ] && continue
              add_message "Edited tutorial for:" "$f"
            done
          fi

          # Deleted files
          if [ -n "${{ steps.changes.outputs.deleted }}" ]; then
            for f in ${{ steps.changes.outputs.deleted }}; do
              [ "$f" = "$skip_file" ] && continue
              add_message "Deleted tutorial for:" "$f"
            done
          fi

          # Fallback if no relevant files
          if [ -z "$MESSAGE" ]; then
            MESSAGE="No tutorial changes detected."
          fi

          # Escape quotes for JSON
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | sed 's/"/\\"/g')
          echo "message=$MESSAGE_ESCAPED" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"${{ steps.msg.outputs.message }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}
