name: Notify Discord on Push

on: push

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changes
        run: |
          echo "added=$(git diff --name-only --diff-filter=A HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "modified=$(git diff --name-only --diff-filter=M HEAD~1 HEAD)" >> $GITHUB_OUTPUT
          echo "deleted=$(git.diff --name-only --diff-filter=D HEAD~1 HEAD)" >> $GITHUB_OUTPUT

      - name: Build Discord embed
        id: msg
        run: |
          REPO_OWNER="Necromancer123"
          REPO_NAME="CoinTutorials"
          BRANCH="main"
          GDB_URL="https://gdbrowser.com/"
          skip_file=".github/workflows/discord.yml"

          make_field() {
            local type="$1"
            local file="$2"
            local color="$3"

            FILE_NAME=$(basename "$file" .json)
            GITHUB_URL="https://github.com/$REPO_OWNER/$REPO_NAME/blob/$BRANCH/$file"
            GDB_LINK="${GDB_URL}${FILE_NAME}"

            printf '{"title":"%s","value":"GD Browser Link: %s\nGitHub: %s","inline":false,"color":"%s"}' \
              "$type $FILE_NAME" "$GDB_LINK" "$GITHUB_URL" "$color"
          }

          FIELDS="[]"

          add_field() {
            local json="$1"
            FIELDS=$(echo "$FIELDS" | jq --argjson f "$json" '. += [$f]')
          }

          # Added
          if [ -n "${{ steps.changes.outputs.added }}" ]; then
            for f in ${{ steps.changes.outputs.added }}; do
              [ "$f" = "$skip_file" ] && continue
              add_field "$(make_field Added "$f" "65280")"    # bright green
            done
          fi

          # Modified
          if [ -n "${{ steps.changes.outputs.modified }}" ]; then
            for f in ${{ steps.changes.outputs.modified }}; do
              [ "$f" = "$skip_file" ] && continue
              add_field "$(make_field Edited "$f" "16776960")" # yellow
            done
          fi

          # Deleted
          if [ -n "${{ steps.changes.outputs.deleted }}" ]; then
            for f in ${{ steps.changes.outputs.deleted }}; do
              [ "$f" = "$skip_file" ] && continue
              add_field "$(make_field Deleted "$f" "16711680")" # red
            done
          fi

          if [ "$(echo "$FIELDS" | jq length)" -eq 0 ]; then
            FIELDS='[{"title":"No tutorial changes detected.","value":"","inline":false,"color":"0"}]'
          fi

          echo "embed=$(jq -n --argjson fields "$FIELDS" '{embeds:[{title:"Tutorial Updates",fields:$fields}]}' | sed 's/"/\\"/g')" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"embeds\": ${{ steps.msg.outputs.embed }} }" \
            ${{ secrets.DISCORD_WEBHOOK }}
